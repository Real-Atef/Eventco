"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var queueFair,QueueFair=function(){function QueueFair(){_classCallCheck(this,QueueFair),_defineProperty(this,"reported",0),_defineProperty(this,"isLocal",!1),_defineProperty(this,"debug",!1),_defineProperty(this,"parsing",!1),_defineProperty(this,"protocol","https"),_defineProperty(this,"cookieNameBase","QueueFair-Pass-"),_defineProperty(this,"log",(function(){})),_defineProperty(this,"redirectLoc",null),_defineProperty(this,"adapterResult",null),_defineProperty(this,"adapterQueue",null),_defineProperty(this,"settings",null),_defineProperty(this,"clientName",null),_defineProperty(this,"oldHref",document.location.href),_defineProperty(this,"passed",Array()),_defineProperty(this,"bots",["duckduckbot","duckduckgo","dotbot","linkedinbot","slurp","applebot","yandexbot","yandeximages","bingbot","bingpreview","sogou spider","seznambot","slackbot","nimbostratus","testbot","googlebot","googlebot","mauibot","semrushbot","ahrefsbot","adsbot","petalbot","aspiegelbot","grapeshot","mj12bot","adsbot-google","barkrowler","intelx.io_bot","bot@linkfluence.com","ltx71","adbeat_bot","facebookexternalhit","the knowledge ai","pandalytics","blexbot","hubspot","bytespider","go-http-client"]),_defineProperty(this,"extra",null),_defineProperty(this,"scriptSrc",null)}return _createClass(QueueFair,[{key:"includes",value:function(e,t){return-1!=e.indexOf(t)}},{key:"startsWith",value:function(e,t){return 0===e.indexOf(t)}},{key:"endsWith",value:function(e,t){return-1!=e.indexOf(t)&&e.indexOf(t)==e.length-t.length}},{key:"reset",value:function(){this.parsing=!1,this.passed=Array(),this.redirectLoc=null,this.adapterResult=null,this.adapterQueue=null}},{key:"extractClientName",value:function(){for(var e=document.getElementsByTagName("script"),t=0;t<e.length;t++){var i=e[t],r=i.getAttribute("data-queue-fair-client");if(null!==r){this.clientName=r,i.getAttribute("data-queue-fair-debug")&&(this.debug=!0),this.extra=i.getAttribute("data-queue-fair-extra"),this.scriptSrc=i.getAttribute("src");break}}this.debug&&(this.log=console.log.bind(window.console))}},{key:"extractClientNameFromDataLayer",value:function(){if("undefined"!=typeof dataLayer&&null!==dataLayer&&dataLayer){for(var e in dataLayer){var t=dataLayer[e];if(void 0!==t.g){var i=t.g.queueFairClient;if(void 0!==i){this.clientName=i;var r=t.g.queueFairDebug;void 0===r||"true"!=r&&!r||(this.debug=!0);var a=t.g.queueFairExtra;null!=a&&""!==a&&(this.extra=a);break}}}this.debug&&(this.log=console.log.bind(window.console))}}},{key:"isMatch",value:function(e){return!!(e&&e.activation&&e.activation.rules)&&this.isMatchArray(e.activation.rules)}},{key:"isMatchArray",value:function isMatchArray(arr){for(var expr="",i=0;i<arr.length;i++){var rule=arr[i];rule.operator&&("And"==rule.operator?expr+=" && ":"Or"==rule.operator&&(expr+=" || ")),expr+=this.isRuleMatch(rule)}return this.log("Rule expression is "+expr),eval(expr)}},{key:"isRuleMatch",value:function(e){var t=""+window.location;if(this.log("Loc is "+t),"Domain"==e.component)t=t.replace("http://","").replace("https://","").split(/[/?#]/)[0];else if("Path"==e.component){var i=t.replace("http://","").replace("https://","").split(/[/?#]/)[0];t=t.substring(t.indexOf(i)+i.length);var r=0;this.startsWith(t,":")&&(r=t.indexOf("/"),t=-1!=r?t.substring(r):""),-1!=(r=t.indexOf("#"))&&(t=t.substring(0,r)),-1!=(r=t.indexOf("?"))&&(t=t.substring(0,r)),""==t&&(t="/")}else if("Query"==e.component){var a=t.indexOf("?");t=-1==a||"?"==t?"":t.substring(a+1)}else"Cookie"==e.component&&(t=this.getCookie(e.name));var n=e.value;!1===e.caseSensitive&&(t=t.toLowerCase(),n=n.toLowerCase()),this.log("Testing "+e.component+" "+n+" against "+t);var o=!1;if("Equal"==e.match&&t==n)o=!0;else if("Contain"==e.match&&null!==t&&this.includes(t,n))o=!0;else if("Exist"==e.match)o=null!=t&&""!==t;else if("RegExp"==e.match){null==t&&(t=""),o=new RegExp(n).test(t)}return e.negate&&(o=!o),o}},{key:"onMatch",value:function(e){if(this.isPassed(e)){if(this.log("Already passed "+e.name+"."),"CLEAR"!=this.extra)return!0;var t=this.getCookie(this.cookieNameBase+e.name);if(this.log("Clear receieved - cookie is "+t),""===t)return!0;this.setCookie(e.name,t,20,e.cookieDomain)}return this.log("Checking at server "+e.displayName),this.consultAdapter(e),!1}},{key:"isPassed",value:function(e){if(this.passed[e.name])return this.log("Queue "+e.name+" marked as passed already."),!0;var t=this.getCookie(this.cookieNameBase+e.name);return t&&""!==t?this.includes(t,e.name)?(this.log("Got a queueCookie for "+e.name+" "+t),!0):(this.log("Cookie value is invalid for "+e.name),!1):(this.log("No cookie found for queue "+e.name),!1)}},{key:"getCookie",value:function(e){if(""===e||null===e)return"";for(var t=e+"=",i=decodeURIComponent(document.cookie).split(";"),r=0;r<i.length;r++){for(var a=i[r];" "==a.charAt(0);)a=a.substring(1);if(0===a.indexOf(t))return a.substring(t.length,a.length)}return""}},{key:"gotSettings",value:function(){try{this.log("Got client settings."),this.checkQueryString(),this.parseSettings()}catch(e){this.log("QF Error "),this.log(e),this.errorHandler(e)}}},{key:"parseSettings",value:function(){if(this.settings){var e=this.settings.queues;if(e&&e[0]){this.parsing=!0,this.log("Running through queue rules");for(var t=0;t<e.length;t++){var i=e[t];if(this.passed[i.name])this.log("Already passed "+i.displayName+" "+this.passed[i.name]);else if(this.log("Checking "+i.displayName),this.isMatch(i)){if(this.log("Got a match "+i.displayName),!this.onMatch(i))return void this.log("Found matching unpassed queue "+i.displayName)}else this.log("Rules did not match "+i.displayName)}this.log("All queues checked."),this.parsing=!1,"undefined"!=typeof qfOnJSAdapterComplete&&qfOnJSAdapterComplete()}else this.log("No queues found.")}else this.log("ERROR: Settings not set.")}},{key:"consultAdapter",value:function(e){this.adapterQueue=e;var t=document.createElement("script"),i=this.protocol+"://"+e.adapterServer+"/adapterjs/"+e.name+"?qfa="+this.clientName+"&ts="+(new Date).getTime();i=this.appendExtra(e,i),this.log("Checking adapter "+i),t.src=i,document.getElementsByTagName("head")[0].appendChild(t)}},{key:"appendQueryOrAmp",value:function(e){return-1!=e.indexOf("?")?e+="&":e+="?",e}},{key:"appendVariant",value:function(e,t){this.log("Looking for variant");var i=this.getVariant(e);return null===i?(this.log("No Variant Found"),t):(this.log("Found variant "+i),t=this.appendQueryOrAmp(t),t+="qfv="+encodeURIComponent(i))}},{key:"appendExtra",value:function(e,t){return null===this.extra||""===this.extra?t:(t=this.appendQueryOrAmp(t),t+="qfx="+encodeURIComponent(this.extra))}},{key:"getVariant",value:function(e){if(this.log("Getting variants for "+e.name),!e.activation)return null;var t=e.activation.variantRules;if(!t)return null;this.log("Got variant rules for "+e.name);for(var i=0;i<t.length;i++){var r=t[i],a=r.variant,n=r.rules,o=this.isMatchArray(n);if(this.log("Variant match "+a+" "+o),o)return a}return null}},{key:"gotAdapter",value:function(){try{if(this.log("Got from adapter "+JSON.stringify(this.adapterResult)),!this.adapterResult)return void this.log("ERROR: onAdapter() called without result");if(this.adapterResult.action||this.log("ERROR: onAdapter() called without result action"),"SendToQueue"==this.adapterResult.action){this.log("Sending to queue server.");var e="",t=""+window.location;"disabled"!=this.adapterQueue.dynamicTarget&&(e+="target=",e+=encodeURIComponent(t));var i=this.adapterResult.location;return""!==e&&(i=i+"?"+e),i=this.appendVariant(this.adapterQueue,i),i=this.appendExtra(this.adapterQueue,i),this.log("Redirecting to "+i),this.redirectLoc=i,void setTimeout("queueFair.redirect();",100)}if("CLEAR"==this.adapterResult.action)return this.log("CLEAR received for "+this.adapterResult.queue),this.passed[this.adapterResult.queue]=!0,void(this.parsing&&this.parseSettings());this.setCookie(this.adapterResult.queue,this.adapterResult.validation,60*this.adapterQueue.passedLifetimeMinutes,this.adapterQueue.cookieDomain),this.log("Marking "+this.adapterResult.queue+" as passed by adapter."),this.passed[this.adapterResult.queue]=!0,this.parsing&&this.parseSettings()}catch(e){this.log("QF Error "+e.message),this.errorHandler(e)}}},{key:"redirect",value:function(){window.location=this.redirectLoc}},{key:"setCookie",value:function(e,t,i,r){this.log("Setting cookie for "+e+" to "+t+" on "+r);var a=this.cookieNameBase+e,n=new Date;n.setTime(n.getTime()+1e3*i);var o=a+"="+t;null==r||""===r||(o+="; domain="+r),o+="; path=/;expires="+n.toUTCString(),this.log("Setting cookie "+o),document.cookie=o}},{key:"loadSettings",value:function(){var e=document.createElement("script"),t=this.clientName+"/queue-fair-settings.js";if(!this.isLocal){var i=!1,r=this.scriptSrc;if(null!=r){var a=r.indexOf("://");if(-1!=a){a+=3;var n=r.indexOf("/",a);-1!=n&&(t=this.protocol+"://"+r.substring(a,n)+"/"+t,i=!0)}}i||(t=this.protocol+"://files.queue-fair.net/"+t)}e.src=t,document.getElementsByTagName("head")[0].appendChild(e)}},{key:"checkQueryString",value:function(){var e=""+window.location.search;if(-1!=e.indexOf("qfqid=")){var t=e.indexOf("qfq=");if(-1!=t)for(var i=e.indexOf("&",t),r=e.substring(t+"qfq=".length,i),a=0;a<this.settings.queues.length;a++){var n=this.settings.queues[a];if(n.name==r){this.log("Found queue for querystring "+r);var o=""+e;o=o.substring(o.indexOf("qfqid")),this.setCookie(r,o,60*n.passedLifetimeMinutes,n.cookieDomain),this.log("Marking "+r+" as passed by queryString"),this.passed[r]=!0;var s=""+document.location,u=s.lastIndexOf("#"),l=null;-1!=u&&(l=s.substring(u)),s=s.substring(0,s.indexOf("qfqid=")-1),null!=l&&(s+=l),window.history.replaceState({},document.title,s)}}}}},{key:"isBot",value:function(){var e=navigator.userAgent.toLowerCase();this.log("Agent is "+e);for(var t=0;t<this.bots.length;t++){var i=this.bots[t];if(-1!=e.indexOf(i))return this.log("Bot found "+i),!0}return!1}},{key:"onLocChange",value:function(){try{this.reset(),this.parseSettings()}catch(e){this.log("QF Error on Loc Change"),this.log(e),this.errorHandler(e)}}},{key:"locWatch",value:function(){var e=document.querySelector("body");new MutationObserver((function(e){e.forEach((function(e){queueFair.oldHref!=document.location.href&&(queueFair.oldHref=document.location.href,queueFair.log("Location changed to "+queueFair.oldHref),queueFair.onLocChange())}))})).observe(e,{childList:!0,subtree:!0})}},{key:"errorHandler",value:function(e){try{if(!window.XMLHttpRequest)return;if(this.reported>5)return;this.reported++;var t={name:e.name,message:e.message,url:document.location.href,stack:e.stack},i=new XMLHttpRequest;i.open("POST","https://queue-fair.com/onerror",!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.send("err="+JSON.stringify(t))}catch(e){console.log("Error in handler"),console.log(e)}}},{key:"go",value:function(){try{if(window.addEventListener("load",(function(){queueFair.locWatch()})),this.extractClientName(),this.clientName||this.extractClientNameFromDataLayer(),!this.clientName)return void console.log("ERROR Queue-Fair couldn't find the client name. Please check the data-queue-fair-client parameter in the script tag on your page or tag manager.");if(this.isBot())return void this.log("This is a bot - ignoring");this.loadSettings()}catch(e){console.log("QF Error "+e.message),this.errorHandler(e)}}}]),QueueFair}();queueFair=new QueueFair,queueFair.go();